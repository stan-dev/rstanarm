<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!-- upstream: inst/BS5/templates/head.html; pkgdown-version: 2.1.3, fe04924 --><!-- https://github.com/r-lib/pkgdown/tree/fe04924b3df129bea60ac871614b01d87bcae147 --><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Estimating Generalized (Non-)Linear Models with Group-Specific Terms with rstanarm • rstanarm</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_3-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- Font Awesome 7.0.1 for Bluesky icon --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" referrerpolicy="no-referrer">
<!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Estimating Generalized (Non-)Linear Models with Group-Specific Terms with rstanarm">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <!-- upstream: inst/BS5/templates/navbar.html; pkgdown-version: 2.1.3, fe04924 -->
<!-- https://github.com/r-lib/pkgdown/tree/fe04924b3df129bea60ac871614b01d87bcae147 -->
<nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">


    <a class="navbar-brand me-2" href="../index.html">
      <!-- Add Stan logo -->
      <picture><source type="image/svg+xml" srcset="../logo.svg"><img src="../logo.png" class="stan-logo" alt="Stan blue hex logo"></source></picture>
      rstanarm
    </a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.32.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html" aria-label="Go to homepage"><span class="fa fa-home fa-lg"></span></a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Vignettes</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Functions</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-other-packages" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Other Packages</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-other-packages">
<li><a class="external-link dropdown-item" href="https://mc-stan.org/bayesplot">bayesplot</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/cmdstanr">cmdstanr</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/loo">loo</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/posterior">posterior</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/projpred">projpred</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/rstan">rstan</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/rstantools">rstantools</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/shinystan">shinystan</a></li>
  </ul>
</li>
<li class="nav-item"><a class="external-link nav-link" href="https://mc-stan.org/about/">About Stan</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://bsky.app/profile/did:plc:qznndgdnkem2yryu7ipqbpv7" aria-label="Visit our Bluesky profile"><span class="fa fa-brands fa-bluesky"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://discourse.mc-stan.org/" aria-label="Visit our forums"><span class="fa fa-users"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/stan-dev/rstanarm/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Estimating Generalized (Non-)Linear Models with Group-Specific Terms with rstanarm</h1>
                        <h4 data-toc-skip class="author">Jonah Gabry and
Ben Goodrich</h4>
            
            <h4 data-toc-skip class="date">2025-12-01</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/stan-dev/rstanarm/blob/New-pkgdown-theme/vignettes/glmer.Rmd" class="external-link"><code>vignettes/glmer.Rmd</code></a></small>
      <div class="d-none name"><code>glmer.Rmd</code></div>
    </div>

    
    
<!--
%\VignetteEngine{knitr::rmarkdown}
%\VignetteIndexEntry{stan_glmer: GLMs with Group-Specific Terms}
-->
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/bayesplot/" class="external-link">bayesplot</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/get_theme.html" class="external-link">theme_set</a></span><span class="op">(</span><span class="fu">bayesplot</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/bayesplot/reference/theme_default.html" class="external-link">theme_default</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette explains how to use the <code>stan_lmer</code>,
<code>stan_glmer</code>, <code>stan_nlmer</code>, and
<code>stan_gamm4</code> functions in the <strong>rstanarm</strong>
package to estimate linear and generalized (non-)linear models with
parameters that may vary across groups. Before continuing, we recommend
reading the vignettes (navigate up one level) for the various ways to
use the <code>stan_glm</code> function. The <em>Hierarchical Partial
Pooling</em> vignette also has examples of both <code>stan_glm</code>
and <code>stan_glmer</code>.</p>
</div>
<div class="section level2">
<h2 id="glms-with-group-specific-terms">GLMs with group-specific terms<a class="anchor" aria-label="anchor" href="#glms-with-group-specific-terms"></a>
</h2>
<p>Models with this structure are refered to by many names: multilevel
models, (generalized) linear mixed (effects) models (GLMM), hierarchical
(generalized) linear models, etc. In the simplest case, the model for an
outcome can be written as <span class="math display">\[\mathbf{y} =
\alpha + \mathbf{X} \boldsymbol{\beta} + \mathbf{Z} \mathbf{b} +
\boldsymbol{\epsilon},\]</span> where <span class="math inline">\(\mathbf{X}\)</span> is a matrix predictors that is
analogous to that in Generalized Linear Models and <span class="math inline">\(\mathbf{Z}\)</span> is a matrix that encodes
deviations in the predictors across specified groups.</p>
<p>The terminology for the unknowns in the model is diverse. To
frequentists, the error term consists of <span class="math inline">\(\mathbf{Z}\mathbf{b} +
\boldsymbol{\epsilon}\)</span> and the observations within each group
are <em>not</em> independent conditional on <span class="math inline">\(\mathbf{X}\)</span> alone. Since, <span class="math inline">\(\mathbf{b}\)</span> is considered part of the
random error term, frequentists allow themselves to make distributional
assumptions about <span class="math inline">\(\mathbf{b}\)</span>,
invariably that it is distributed multivariate normal with mean vector
zero and structured covariance matrix <span class="math inline">\(\boldsymbol{\Sigma}\)</span>. If <span class="math inline">\(\epsilon_i\)</span> is also distributed
(univariate) normal with mean zero and standard deviation <span class="math inline">\(\sigma\)</span>, then <span class="math inline">\(\mathbf{b}\)</span> can be integrated out, which
implies <span class="math display">\[\mathbf{y} \thicksim
\mathcal{N}\left(\alpha + \mathbf{X}\boldsymbol{\beta}, \sigma^2
\mathbf{I}+\mathbf{Z}^\top \boldsymbol{\Sigma} \mathbf{Z}
\right),\]</span> and it is possible to maximize this likelihood
function by choosing proposals for the parameters <span class="math inline">\(\alpha\)</span>, <span class="math inline">\(\boldsymbol{\beta}\)</span>, and (the free
elements of) <span class="math inline">\(\boldsymbol{\Sigma}\)</span>.</p>
<p>Consequently, frequentists refer to <span class="math inline">\(\mathbf{b}\)</span> as the <em>random effects</em>
because they capture the random deviation in the effects of predictors
from one group to the next. In contradistinction, <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\boldsymbol{\beta}\)</span> are referred to as
<em>fixed effects</em> because they are the same for all groups.
Moreover, <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\boldsymbol{\beta}\)</span> persist in the model
in hypothetical replications of the analysis that draw the members of
the groups afresh every time, whereas <span class="math inline">\(\mathbf{b}\)</span> would differ from one
replication to the next. Consequently, <span class="math inline">\(\mathbf{b}\)</span> is not a “parameter” to be
estimated because parameters are unknown constants that are fixed in
repeated sampling.</p>
<p>Bayesians condition on the data in-hand without reference to repeated
sampling and describe their <em>beliefs</em> about the unknowns with
prior distributions before observing the data. Thus, the likelihood in a
simple hierarchical model in <strong>rstarnarm</strong> is <span class="math display">\[\mathbf{y} \thicksim \mathcal{N}\left(\alpha +
\mathbf{X}\boldsymbol{\beta} + \mathbf{Z}\mathbf{b}, \sigma^2
\mathbf{I}\right)\]</span> and the observations are independent
conditional on <span class="math inline">\(\mathbf{X}\)</span> and <span class="math inline">\(\mathbf{Z}\)</span>. In this formulation, there
are</p>
<ul>
<li>intercept(s) and coefficients that are <em>common across
groups</em>
</li>
<li>deviations in the intercept(s) and / or coefficients that <em>vary
across groups</em>
</li>
</ul>
<p>Bayesians are compelled to state their prior beliefs about all
unknowns and the usual assumption (which is maintained in
<strong>rstanarm</strong>) is that <span class="math inline">\(\mathbf{b} \thicksim
\mathcal{N}\left(\mathbf{0},\boldsymbol{\Sigma}\right),\)</span> but it
is then necessary to state prior beliefs about <span class="math inline">\(\boldsymbol{\Sigma}\)</span>, in addition to <span class="math inline">\(\alpha\)</span>, <span class="math inline">\(\boldsymbol{\beta}\)</span>, and <span class="math inline">\(\sigma\)</span>.</p>
<p>One of the many challenges of fitting models to data comprising
multiple groupings is confronting the tradeoff between validity and
precision. An analysis that disregards between-group heterogeneity can
yield parameter estimates that are wrong if there is between-group
heterogeneity but would be relatively precise if there actually were no
between-group heterogeneity. Group-by-group analyses, on the other hand,
are valid but produces estimates that are relatively imprecise. While
complete pooling or no pooling of data across groups is sometimes called
for, models that ignore the grouping structures in the data tend to
underfit or overfit (Gelman et al.,2013). Hierarchical modeling provides
a compromise by allowing parameters to vary by group at lower levels of
the hierarchy while estimating common parameters at higher levels.
Inference for each group-level parameter is informed not only by the
group-specific information contained in the data but also by the data
for other groups as well. This is commonly referred to as <em>borrowing
strength</em> or <em>shrinkage</em>.</p>
<p>In <strong>rstanarm</strong>, these models can be estimated using the
<code>stan_lmer</code> and <code>stan_glmer</code> functions, which are
similar in syntax to the <code>lmer</code> and <code>glmer</code>
functions in the <strong>lme4</strong> package. However, rather than
performing (restricted) maximum likelihood (RE)ML estimation, Bayesian
estimation is performed via MCMC. The Bayesian model adds independent
prior distributions on the regression coefficients (in the same way as
<code>stan_glm</code>) as well as priors on the terms of a decomposition
of the covariance matrices of the group-specific parameters. These
priors are discussed in greater detail below.</p>
</div>
<div class="section level2">
<h2 id="priors-on-covariance-matrices">Priors on covariance matrices<a class="anchor" aria-label="anchor" href="#priors-on-covariance-matrices"></a>
</h2>
<p>In this section we discuss a flexible family of prior distributions
for the unknown covariance matrices of the group-specific
coefficients.</p>
<div class="section level4">
<h4 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h4>
<p>For each group, we assume the vector of varying slopes and intercepts
is a zero-mean random vector following a multivariate Gaussian
distribution with an unknown covariance matrix to be estimated.
Unfortunately, expressing prior information about a covariance matrix is
not intuitive and can also be computationally challenging. When the
covariance matrix is not <span class="math inline">\(1\times 1\)</span>,
it is often both much more intuitive and efficient to work instead with
the <strong>correlation</strong> matrix and variances. When the
covariance matrix is <span class="math inline">\(1\times 1\)</span>, we
still denote it as <span class="math inline">\(\boldsymbol{\Sigma}\)</span> but most of the
details in this section do not apply.</p>
<p>The variances are in turn decomposed into the product of a simplex
vector (probability vector) and the trace of the implied covariance
matrix, which is defined as the sum of its diagonal elements. Finally,
this trace is set equal to the product of the order of the matrix and
the square of a scale parameter. This implied prior on a covariance
matrix is represented by the <code>decov</code> (short for decomposition
of covariance) function in <strong>rstanarm</strong>.</p>
</div>
<div class="section level4">
<h4 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a>
</h4>
<p>Using the decomposition described above, the prior used for a
correlation matrix <span class="math inline">\(\Omega\)</span> is called
the LKJ distribution and has a probability density function proportional
to the determinant of the correlation matrix raised to a power of <span class="math inline">\(\zeta\)</span> minus one:</p>
<p><span class="math display">\[ f(\Omega | \zeta) \propto
\text{det}(\Omega)^{\zeta - 1}, \quad \zeta &gt; 0. \]</span></p>
<p>The shape of this prior depends on the value of the regularization
parameter, <span class="math inline">\(\zeta\)</span> in the following
ways:</p>
<ul>
<li>If <span class="math inline">\(\zeta = 1\)</span> (the default),
then the LKJ prior is jointly uniform over all correlation matrices of
the same dimension as <span class="math inline">\(\Omega\)</span>.</li>
<li>If <span class="math inline">\(\zeta &gt; 1\)</span>, then the mode
of the distribution is the identity matrix. The larger the value of
<span class="math inline">\(\zeta\)</span> the more sharply peaked the
density is at the identity matrix.</li>
<li>If <span class="math inline">\(0 &lt; \zeta &lt; 1\)</span>, then
the density has a trough at the identity matrix.</li>
</ul>
<p>The <span class="math inline">\(J \times J\)</span> covariance matrix
<span class="math inline">\(\Sigma\)</span> of a random vector <span class="math inline">\(\boldsymbol{\theta} =
(\theta_1, \dots, \theta_J)\)</span> has diagonal entries <span class="math inline">\({\Sigma}_{jj} = \sigma^2_j =
\text{var}(\theta_j)\)</span>. Therefore, the trace of the covariance
matrix is equal to the sum of the variances. We set the trace equal to
the product of the order of the covariance matrix and the square of a
positive scale parameter <span class="math inline">\(\tau\)</span>:</p>
<p><span class="math display">\[\text{tr}(\Sigma) = \sum_{j=1}^{J}
\Sigma_{jj} = J\tau^2.\]</span></p>
<p>The vector of variances is set equal to the product of a simplex
vector <span class="math inline">\(\boldsymbol{\pi}\)</span> — which is
non-negative and sums to 1 — and the scalar trace: <span class="math inline">\(J \tau^2 \boldsymbol{\pi}\)</span>. Each element
<span class="math inline">\(\pi_j\)</span> of <span class="math inline">\(\boldsymbol{\pi}\)</span> then represents the
proportion of the trace (total variance) attributable to the
corresponding variable <span class="math inline">\(\theta_j\)</span>.</p>
<p>For the simplex vector <span class="math inline">\(\boldsymbol{\pi}\)</span> we use a symmetric
Dirichlet prior, which has a single <em>concentration</em> parameter
<span class="math inline">\(\gamma &gt; 0\)</span>:</p>
<ul>
<li>If <span class="math inline">\(\gamma = 1\)</span> (the default),
then the prior is jointly uniform over the space of simplex vectors with
<span class="math inline">\(J\)</span> elements.</li>
<li>If <span class="math inline">\(\gamma &gt; 1\)</span>, then the
prior mode corresponds to all variables having the same (proportion of
total) variance, which can be used to ensure that the posterior
variances are not zero. As the concentration parameter approaches
infinity, this mode becomes more pronounced.</li>
<li>If <span class="math inline">\(0 &lt; \gamma &lt; 1\)</span>, then
the variances are more polarized.</li>
</ul>
<p>If all the elements of <span class="math inline">\(\boldsymbol{\theta}\)</span> were multiplied by
the same number <span class="math inline">\(k\)</span>, the trace of
their covariance matrix would increase by a factor of <span class="math inline">\(k^2\)</span>. For this reason, it is sensible to
use a scale-invariant prior for <span class="math inline">\(\tau\)</span>. We choose a Gamma distribution,
with shape and scale parameters both set to <span class="math inline">\(1\)</span> by default, implying a unit-exponential
distribution. Users can set the shape hyperparameter to some value
greater than one to ensure that the posterior trace is not zero. In the
case where <span class="math inline">\(\boldsymbol{\Sigma}\)</span> is
<span class="math inline">\(1\times 1\)</span>, <span class="math inline">\(\tau\)</span> is the cross-group standard
deviation in the parameters and its square is the variance (so the Gamma
prior with its shape and scale directly applies to the cross-group
standard deviation in the parameters).</p>
</div>
</div>
<div class="section level2">
<h2 id="comparison-with-lme4">Comparison with <strong>lme4</strong><a class="anchor" aria-label="anchor" href="#comparison-with-lme4"></a>
</h2>
<p>There are several advantages to estimating these models using
<strong>rstanarm</strong> rather than the <strong>lme4</strong> package.
There are also a few drawbacks. In this section we briefly discuss what
we find to be the two most important advantages as well as an important
disadvantage.</p>
<div class="section level4">
<h4 id="advantage-better-uncertainty-estimates">Advantage: better uncertainty estimates<a class="anchor" aria-label="anchor" href="#advantage-better-uncertainty-estimates"></a>
</h4>
<p>While <strong>lme4</strong> uses (restricted) maximum likelihood
(RE)ML estimation, <strong>rstanarm</strong> enables full Bayesian
inference via MCMC to be performed. It is well known that (RE)ML tends
to underestimate uncertainties because it relies on point estimates of
hyperparameters. Full Bayes, on the other hand, propagates the
uncertainty in the hyperparameters throughout all levels of the model
and provides more appropriate estimates of uncertainty for models that
consist of a mix of common and group-specific parameters.</p>
</div>
<div class="section level4">
<h4 id="advantage-incorporate-prior-information">Advantage: incorporate prior information<a class="anchor" aria-label="anchor" href="#advantage-incorporate-prior-information"></a>
</h4>
<p>The <code>stan_glmer</code> and <code>stan_lmer</code> functions
allow the user to specify prior distributions over the regression
coefficients as well as any unknown covariance matrices. There are
various reasons to specify priors, from helping to stabilize computation
to incorporating important information into an analysis that does not
enter through the data.</p>
</div>
<div class="section level4">
<h4 id="disadvantage-speed">Disadvantage: speed<a class="anchor" aria-label="anchor" href="#disadvantage-speed"></a>
</h4>
<p>The benefits of full Bayesian inference (via MCMC) come with a cost.
Fitting models with (RE)ML will tend to be much faster than fitting a
similar model using MCMC. Speed comparable to <strong>lme4</strong> can
be obtained with <strong>rstanarm</strong> using approximate Bayesian
inference via the mean-field and full-rank variational algorithms (see
<code><a href="../reference/rstanarm-package.html">help("rstanarm-package", "rstanarm")</a></code> for details). These
algorithms can be useful to narrow the set of candidate models in large
problems, but MCMC should always be used for final statistical
inference.</p>
</div>
</div>
<div class="section level2">
<h2 id="relationship-to-glmer">Relationship to <code>glmer</code><a class="anchor" aria-label="anchor" href="#relationship-to-glmer"></a>
</h2>
<p>In the <strong>lme4</strong> package, there is a fundamental
distinction between the way that Linear Mixed Models and Generalized
Linear Mixed Models are estimated. In Linear Mixed Models, <span class="math inline">\(\mathbf{b}\)</span> can be integrated out
analytically, leaving a likelihood function that can be maximized over
proposals for the parameters. To estimate a Linear Mixed Model, one can
call the <code>lmer</code> function.</p>
<p>Generalized Linear Mixed Models are appropriate when the conditional
mean of the outcome is determined by an inverse link function, <span class="math inline">\(\boldsymbol{\mu} = g\left(\alpha + \mathbf{X}
\boldsymbol{\beta} + \mathbf{Z}\mathbf{b}\right)\)</span>. If <span class="math inline">\(g\left(\cdot\right)\)</span> is not the identity
function, then it is not possible to integrate out <span class="math inline">\(\mathbf{b}\)</span> analytically and numerical
integration must be used. To estimate a Generalized Linear Mixed Model,
one can call the <code>glmer</code> function and specify the
<code>family</code> argument.</p>
<p>In the <strong>rstanarm</strong> package, there is no such
fundamental distinction; in fact <code>stan_lmer</code> simply calls
<code>stan_glmer</code> with
<code>family = gaussian(link = "identity")</code>. Bayesians do not
(have to) integrate <span class="math inline">\(\mathbf{b}\)</span> out
of the likelihood and if <span class="math inline">\(\mathbf{b}\)</span>
is not of interest, then the margins of its posterior distribution can
simply be ignored.</p>
</div>
<div class="section level2">
<h2 id="relationship-to-gamm4">Relationship to <code>gamm4</code><a class="anchor" aria-label="anchor" href="#relationship-to-gamm4"></a>
</h2>
<p>The <strong>rstanarm</strong> package includes a
<code>stan_gamm4</code> function that is similar to the
<code>gamm4</code> function in the <strong>gamm4</strong> package, which
is in turn similar to the <code>gamm</code> function in the
<strong>mgcv</strong> package. The substring <code>gamm</code> stands
for Generalized Additive Mixed Models, which differ from Generalized
Additive Models (GAMs) due to the presence of group-specific terms that
can be specified with the syntax of <strong>lme4</strong>. Both GAMs and
GAMMs include nonlinear functions of (non-categorical) predictors called
“smooths”. In the example below, so-called “thin-plate splines” are used
to model counts of roaches where we might fear that the number of
roaches in the current period is an exponentially increasing function of
the number of roaches in the previous period. Unlike
<code>stan_glmer</code>, in <code>stan_gamm4</code> it is necessary to
specify group-specific terms as a one-sided formula that is passed to
the <code>random</code> argument as in the <code>lme</code> function in
the <strong>nlme</strong> package.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/rstanarm/">rstanarm</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">roaches</span><span class="op">)</span></span>
<span><span class="va">roaches</span><span class="op">$</span><span class="va">roach1</span> <span class="op">&lt;-</span> <span class="va">roaches</span><span class="op">$</span><span class="va">roach1</span> <span class="op">/</span> <span class="fl">100</span></span>
<span><span class="va">roaches</span><span class="op">$</span><span class="va">log_exposure2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">roaches</span><span class="op">$</span><span class="va">exposure2</span><span class="op">)</span></span>
<span><span class="va">post</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stan_gamm4.html">stan_gamm4</a></span><span class="op">(</span></span>
<span>  <span class="va">y</span> <span class="op">~</span> <span class="fu">s</span><span class="op">(</span><span class="va">roach1</span><span class="op">)</span> <span class="op">+</span> <span class="va">treatment</span> <span class="op">+</span> <span class="va">log_exposure2</span>,</span>
<span>  random <span class="op">=</span> <span class="op">~</span><span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">senior</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">roaches</span>, </span>
<span>  family <span class="op">=</span> <span class="va">neg_binomial_2</span>, </span>
<span>  QR <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  cores <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">2</span>, </span>
<span>  adapt_delta <span class="op">=</span> <span class="fl">0.99</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">12345</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/stan_gamm4.html">plot_nonlinear</a></span><span class="op">(</span><span class="va">post</span><span class="op">)</span></span></code></pre></div>
<p><img src="glmer_files/figure-html/unnamed-chunk-4-1.png" class="r-plt" width="60%" style="display: block; margin: auto;"></p>
<p>Here we see that the relationship between past and present roaches is
estimated to be nonlinear. For a small number of past roaches, the
function is steep and then it appears to flatten out, although we become
highly uncertain about the function in the rare cases where the number
of past roaches is large.</p>
</div>
<div class="section level2">
<h2 id="relationship-to-nlmer">Relationship to <code>nlmer</code><a class="anchor" aria-label="anchor" href="#relationship-to-nlmer"></a>
</h2>
<p>The <code>stan_gamm4</code> function allows designated predictors to
have a nonlinear effect on what would otherwise be called the “linear”
predictor in Generalized Linear Models. The <code>stan_nlmer</code>
function is similar to the <code>nlmer</code> function in the
<strong>lme4</strong> package, and essentially allows a wider range of
nonlinear functions that relate the linear predictor to the conditional
expectation of a Gaussian outcome.</p>
<p>To estimate an example model with the <code>nlmer</code> function in
the <strong>lme4</strong> package, we start by rescaling the outcome and
main predictor(s) by a constant</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"Orange"</span>, package <span class="op">=</span> <span class="st">"datasets"</span><span class="op">)</span></span>
<span><span class="va">Orange</span><span class="op">$</span><span class="va">age</span> <span class="op">&lt;-</span> <span class="va">Orange</span><span class="op">$</span><span class="va">age</span> <span class="op">/</span> <span class="fl">100</span></span>
<span><span class="va">Orange</span><span class="op">$</span><span class="va">circumference</span> <span class="op">&lt;-</span> <span class="va">Orange</span><span class="op">$</span><span class="va">circumference</span> <span class="op">/</span> <span class="fl">100</span></span></code></pre></div>
<p>Although doing so has no substantive effect on the inferences
obtained, it is numerically much easier for Stan and for
<strong>lme4</strong> to work with variables whose units are such that
the estimated parameters tend to be single-digit numbers that are not
too close to zero. The <code>nlmer</code> function requires that the
user pass starting values to the ironically-named self-starting
non-linear function:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">startvec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>Asym <span class="op">=</span> <span class="fl">2</span>, xmid <span class="op">=</span> <span class="fl">7.25</span>, scal <span class="op">=</span> <span class="fl">3.5</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lme4/lme4/" class="external-link">lme4</a></span><span class="op">)</span></span>
<span><span class="va">nm1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/nlmer.html" class="external-link">nlmer</a></span><span class="op">(</span><span class="va">circumference</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/SSlogis.html" class="external-link">SSlogis</a></span><span class="op">(</span><span class="va">age</span>, <span class="va">Asym</span>, <span class="va">xmid</span>, <span class="va">scal</span><span class="op">)</span> <span class="op">~</span> <span class="va">Asym</span><span class="op">|</span><span class="va">Tree</span>,</span>
<span>             data <span class="op">=</span> <span class="va">Orange</span>, start <span class="op">=</span> <span class="va">startvec</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">nm1</span><span class="op">)</span></span></code></pre></div>
<pre><code>Warning in vcov.merMod(object, use.hessian = use.hessian): variance-covariance matrix computed from finite-difference Hessian is
not positive definite or contains NA values: falling back to var-cov estimated from RX</code></pre>
<pre><code>Warning in vcov.merMod(object, correlation = correlation, sigm = sig): variance-covariance matrix computed from finite-difference Hessian is
not positive definite or contains NA values: falling back to var-cov estimated from RX</code></pre>
<pre><code>Nonlinear mixed model fit by maximum likelihood  ['nlmerMod']
Formula: circumference ~ SSlogis(age, Asym, xmid, scal) ~ Asym | Tree
   Data: Orange

      AIC       BIC    logLik -2*log(L)  df.resid 
    -49.2     -41.4      29.6     -59.2        30 

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-1.9170 -0.5421  0.1754  0.7116  1.6820 

Random effects:
 Groups   Name Variance Std.Dev.
 Tree     Asym 0.100149 0.31646 
 Residual      0.006151 0.07843 
Number of obs: 35, groups:  Tree, 5

Fixed effects:
     Estimate Std. Error t value
Asym   1.9205     0.1558   12.32
xmid   7.2791     0.3444   21.14
scal   3.4807     0.2631   13.23

Correlation of Fixed Effects:
     Asym  xmid 
xmid 0.384      
scal 0.362 0.762</code></pre>
<p>Note the warning messages indicating difficulty estimating the
variance-covariance matrix. Although <strong>lme4</strong> has a
fallback mechanism, the need to utilize it suggests that the sample is
too small to sustain the asymptotic assumptions underlying the maximum
likelihood estimator.</p>
<p>In the above example, we use the <code>SSlogis</code> function, which
is a lot like the logistic CDF, but with an additional <code>Asym</code>
argument that need not be one and indicates what value the function
approaches for large values of the first argument. In this case, we can
interpret the asymptote as the maximum possible circumference for an
orange. However, this asymptote is allowed to vary from tree to tree
using the <code>Asym | Tree</code> syntax, which reflects an assumption
that the asymptote for a randomly-selected tree deviates from the
asymptote for the population of orange trees in a Gaussian fashion with
mean zero and an unknown standard deviation.</p>
<p>The <code>nlmer</code> function supports user-defined non-linear
functions, whereas the <code>stan_nlmer</code> function only supports
the pre-defined non-linear functions starting with <code>SS</code> in
the <strong>stats</strong> package, which are</p>
<pre><code> [1] "SSasymp"     "SSasympOff"  "SSasympOrig" "SSbiexp"     "SSfol"      
 [6] "SSfpl"       "SSgompertz"  "SSlogis"     "SSmicmen"    "SSweibull"  </code></pre>
<p>To fit essentially the same model using Stan’s implementation of
MCMC, we add a <code>stan_</code> prefix</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">post1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stan_nlmer.html">stan_nlmer</a></span><span class="op">(</span><span class="va">circumference</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/SSlogis.html" class="external-link">SSlogis</a></span><span class="op">(</span><span class="va">age</span>, <span class="va">Asym</span>, <span class="va">xmid</span>, <span class="va">scal</span><span class="op">)</span> <span class="op">~</span> <span class="va">Asym</span><span class="op">|</span><span class="va">Tree</span>,</span>
<span>                    data <span class="op">=</span> <span class="va">Orange</span>, cores <span class="op">=</span> <span class="fl">2</span>, seed <span class="op">=</span> <span class="fl">12345</span>, init_r <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">post1</span></span></code></pre></div>
<pre><code>stan_nlmer
 family:       gaussian [inv_SSlogis]
 formula:      circumference ~ SSlogis(age, Asym, xmid, scal) ~ Asym | Tree
 observations: 35
------
     Median MAD_SD
Asym 1.9    0.1   
xmid 7.2    0.4   
scal 3.4    0.3   

Auxiliary parameter(s):
      Median MAD_SD
sigma 0.1    0.0   

Error terms:
 Groups   Name Std.Dev.
 Tree     Asym 0.31    
 Residual      0.09    
Num. levels: Tree 5 

------
* For help interpreting the printed output see ?print.stanreg
* For info on the priors used see ?prior_summary.stanreg</code></pre>
<p>In <code>stan_nlmer</code>, it is not necessary to supply starting
values; however, in this case it was necessary to specify the
<code>init_r</code> argument so that the randomly-chosen starting values
were not more than <span class="math inline">\(0.5\)</span> away from
zero (in the unconstrained parameter space). The default value of <span class="math inline">\(2.0\)</span> produced suboptimal results.</p>
<p>As can be seen, the posterior medians and estimated standard
deviations in the MCMC case are quite similar to the maximum likelihood
estimates and estimated standard errors. However,
<code>stan_nlmer</code> produces uncertainty estimates for the
tree-specific deviations in the asymptote, which are considerable.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">post1</span>, regex_pars <span class="op">=</span> <span class="st">"^[b]"</span><span class="op">)</span></span></code></pre></div>
<p><img src="glmer_files/figure-html/unnamed-chunk-10-1.png" class="r-plt" width="60%" style="display: block; margin: auto;"></p>
<p>As can be seen, the age of the tree has a non-linear effect on the
predicted circumference of the tree (here for a out-of-sample tree):</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>age <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">20</span>, Tree <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="st">"6"</span>, levels <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">PPD</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/posterior_predict.stanreg.html">posterior_predict</a></span><span class="op">(</span><span class="va">post1</span>, newdata <span class="op">=</span> <span class="va">nd</span><span class="op">)</span></span>
<span><span class="va">PPD_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">20</span>, each <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">PPD</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                     circumference <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">PPD</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">PPD_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">age</span>, <span class="va">circumference</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="glmer_files/figure-html/unnamed-chunk-11-1.png" class="r-plt" width="60%" style="display: block; margin: auto;"></p>
<p>If we were pharmacological, we could evaluate drug concentration
using a first-order compartment model, such as</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">post3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stan_nlmer.html">stan_nlmer</a></span><span class="op">(</span><span class="va">conc</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/SSfol.html" class="external-link">SSfol</a></span><span class="op">(</span><span class="va">Dose</span>, <span class="va">Time</span>, <span class="va">lKe</span>, <span class="va">lKa</span>, <span class="va">lCl</span><span class="op">)</span> <span class="op">~</span> </span>
<span>                    <span class="op">(</span><span class="fl">0</span> <span class="op">+</span> <span class="va">lKe</span> <span class="op">+</span> <span class="va">lKa</span> <span class="op">+</span> <span class="va">lCl</span> <span class="op">|</span> <span class="va">Subject</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">Theoph</span>,</span>
<span>                    cores <span class="op">=</span> <span class="fl">2</span>, seed <span class="op">=</span> <span class="fl">12345</span>, </span>
<span>                    QR <span class="op">=</span> <span class="cn">TRUE</span>, init_r <span class="op">=</span> <span class="fl">0.25</span>, adapt_delta <span class="op">=</span> <span class="fl">0.999</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/pairs.html" class="external-link">pairs</a></span><span class="op">(</span><span class="va">post3</span>, regex_pars <span class="op">=</span> <span class="st">"^l"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/pairs.html" class="external-link">pairs</a></span><span class="op">(</span><span class="va">post3</span>, regex_pars <span class="op">=</span> <span class="st">"igma"</span><span class="op">)</span></span></code></pre></div>
<p>However, in this case the posterior distribution is bimodal Thus, you
should always be running many chains when using Stan, especially
<code>stan_nlmer</code>.</p>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>There are model fitting functions in the <strong>rstanarm</strong>
package that can do essentially all of what can be done in the
<strong>lme4</strong> and <strong>gamm4</strong> packages — in the sense
that they can fit models with multilevel structure and / or nonlinear
relationships — and propagate the uncertainty in the parameter estimates
to the predictions and other functions of interest. The documentation of
<strong>lme4</strong> and <strong>gamm4</strong> has various warnings
that acknowledge that the estimated standard errors, confidence
intervals, etc. are not entirely correct, even from a frequentist
perspective.</p>
<p>A frequentist point estimate would also completely miss the second
mode in the last example with <code>stan_nlmer</code>. Thus, there is
considerable reason to prefer the <strong>rstanarm</strong> variants of
these functions for regression modeling. The only disadvantage is the
execution time required to produce an answer that properly captures the
uncertainty in the estimates of complicated models such as these.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Jonah Gabry, Ben Goodrich.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
