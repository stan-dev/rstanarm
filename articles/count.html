<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!-- upstream: inst/BS5/templates/head.html; pkgdown-version: 2.1.3, fe04924 --><!-- https://github.com/r-lib/pkgdown/tree/fe04924b3df129bea60ac871614b01d87bcae147 --><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Estimating Generalized Linear Models for Count Data with rstanarm • rstanarm</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_3-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- Font Awesome 7.0.1 for Bluesky icon --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" referrerpolicy="no-referrer">
<!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Estimating Generalized Linear Models for Count Data with rstanarm">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <!-- upstream: inst/BS5/templates/navbar.html; pkgdown-version: 2.1.3, fe04924 -->
<!-- https://github.com/r-lib/pkgdown/tree/fe04924b3df129bea60ac871614b01d87bcae147 -->
<nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">


    <a class="navbar-brand me-2" href="../index.html">
      <!-- Add Stan logo -->
      <picture><source type="image/svg+xml" srcset="../logo.svg"><img src="../logo.png" class="stan-logo" alt="Stan blue hex logo"></source></picture>
      rstanarm
    </a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.32.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html" aria-label="Go to homepage"><span class="fa fa-home fa-lg"></span></a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Vignettes</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Functions</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-other-packages" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Other Packages</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-other-packages">
<li><a class="external-link dropdown-item" href="https://mc-stan.org/bayesplot">bayesplot</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/cmdstanr">cmdstanr</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/loo">loo</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/posterior">posterior</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/projpred">projpred</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/rstan">rstan</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/rstantools">rstantools</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/shinystan">shinystan</a></li>
  </ul>
</li>
<li class="nav-item"><a class="external-link nav-link" href="https://mc-stan.org/about/">About Stan</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://bsky.app/profile/did:plc:qznndgdnkem2yryu7ipqbpv7" aria-label="Visit our Bluesky profile"><span class="fa fa-brands fa-bluesky"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://discourse.mc-stan.org/" aria-label="Visit our forums"><span class="fa fa-users"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/stan-dev/rstanarm/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Estimating Generalized Linear Models for Count Data with rstanarm</h1>
                        <h4 data-toc-skip class="author">Jonah Gabry and
Ben Goodrich</h4>
            
            <h4 data-toc-skip class="date">2025-12-01</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/stan-dev/rstanarm/blob/New-pkgdown-theme/vignettes/count.Rmd" class="external-link"><code>vignettes/count.Rmd</code></a></small>
      <div class="d-none name"><code>count.Rmd</code></div>
    </div>

    
    
<!--
%\VignetteEngine{knitr::rmarkdown}
%\VignetteIndexEntry{stan_glm: GLMs for Count Data}
-->
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/bayesplot/" class="external-link">bayesplot</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/get_theme.html" class="external-link">theme_set</a></span><span class="op">(</span><span class="fu">bayesplot</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/bayesplot/reference/theme_default.html" class="external-link">theme_default</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette explains how to estimate generalized linear models
(GLMs) for count data using the <code>stan_glm</code> function in the
<strong>rstanarm</strong> package.</p>
<p>The four steps of a Bayesian analysis are</p>
<ol style="list-style-type: decimal">
<li>Specify a joint distribution for the outcome(s) and all the
unknowns, which typically takes the form of a marginal prior
distribution for the unknowns multiplied by a likelihood for the
outcome(s) conditional on the unknowns. This joint distribution is
proportional to a posterior distribution of the unknowns conditional on
the observed data</li>
<li>Draw from posterior distribution using Markov Chain Monte Carlo
(MCMC).</li>
<li>Evaluate how well the model fits the data and possibly revise the
model.</li>
<li>Draw from the posterior predictive distribution of the outcome(s)
given interesting values of the predictors in order to visualize how a
manipulation of a predictor affects (a function of) the outcome(s).</li>
</ol>
<p>Steps 3 and 4 are covered in more depth by the vignette entitled <a href="rstanarm.html">“How to Use the <strong>rstanarm</strong>
Package”</a>. This vignette focuses on Step 1 for Poisson and negative
binomial regression models using the <code>stan_glm</code> function.</p>
</div>
<div class="section level2">
<h2 id="likelihood">Likelihood<a class="anchor" aria-label="anchor" href="#likelihood"></a>
</h2>
<p>If the outcome for a single observation <span class="math inline">\(y\)</span> is assumed to follow a Poisson
distribution, the likelihood for one observation can be written as a
conditionally Poisson PMF</p>
<p><span class="math display">\[\tfrac{1}{y!} \lambda^y
e^{-\lambda},\]</span></p>
<p>where <span class="math inline">\(\lambda = E(y | \mathbf{x}) =
g^{-1}(\eta)\)</span> and <span class="math inline">\(\eta = \alpha +
\mathbf{x}^\top \boldsymbol{\beta}\)</span> is a linear predictor. For
the Poisson distribution it is also true that <span class="math inline">\(\lambda = Var(y | \mathbf{x})\)</span>, i.e. the
mean and variance are both <span class="math inline">\(\lambda\)</span>.
Later in this vignette we also show how to estimate a negative binomial
regression, which relaxes this assumption of equal conditional mean and
variance of <span class="math inline">\(y\)</span>.</p>
<p>Because the rate parameter <span class="math inline">\(\lambda\)</span> must be positive, for a Poisson
GLM the <em>link</em> function <span class="math inline">\(g\)</span>
maps between the positive real numbers <span class="math inline">\(\mathbb{R}^+\)</span> (the support of <span class="math inline">\(\lambda\)</span>) and the set of all real numbers
<span class="math inline">\(\mathbb{R}\)</span>. When applied to a
linear predictor <span class="math inline">\(\eta\)</span> with values
in <span class="math inline">\(\mathbb{R}\)</span>, the inverse link
function <span class="math inline">\(g^{-1}(\eta)\)</span> therefore
returns a positive real number.</p>
<p>Although other link functions are possible, the canonical link
function for a Poisson GLM is the log link <span class="math inline">\(g(x) = \ln{(x)}\)</span>. With the log link, the
inverse link function is simply the exponential function and the
likelihood for a single observation becomes</p>
<p><span class="math display">\[\frac{g^{-1}(\eta)^y}{y!}
e^{-g^{-1}(\eta)} =
\frac{e^{\eta y}}{y!} e^{-e^\eta}.\]</span></p>
</div>
<div class="section level2">
<h2 id="priors">Priors<a class="anchor" aria-label="anchor" href="#priors"></a>
</h2>
<p>A full Bayesian analysis requires specifying prior distributions
<span class="math inline">\(f(\alpha)\)</span> and <span class="math inline">\(f(\boldsymbol{\beta})\)</span> for the intercept
and vector of regression coefficients. When using <code>stan_glm</code>,
these distributions can be set using the <code>prior_intercept</code>
and <code>prior</code> arguments. The <code>stan_glm</code> function
supports a variety of prior distributions, which are explained in the
<strong>rstanarm</strong> documentation
(<code><a href="../reference/priors.html">help(priors, package = 'rstanarm')</a></code>).</p>
<p>As an example, suppose we have <span class="math inline">\(K\)</span>
predictors and believe — prior to seeing the data — that <span class="math inline">\(\alpha, \beta_1, \dots, \beta_K\)</span> are as
likely to be positive as they are to be negative, but are highly
unlikely to be far from zero. These beliefs can be represented by normal
distributions with mean zero and a small scale (standard deviation). To
give <span class="math inline">\(\alpha\)</span> and each of the <span class="math inline">\(\beta\)</span>s this prior (with a scale of 1,
say), in the call to <code>stan_glm</code> we would include the
arguments <code>prior_intercept = normal(0,1)</code> and
<code>prior = normal(0,1)</code>.</p>
<p>If, on the other hand, we have less a priori confidence that the
parameters will be close to zero then we could use a larger scale for
the normal distribution and/or a distribution with heavier tails than
the normal like the Student t distribution. <strong>Step 1</strong> in
the “How to Use the <strong>rstanarm</strong> Package” vignette
discusses one such example.</p>
</div>
<div class="section level2">
<h2 id="posterior">Posterior<a class="anchor" aria-label="anchor" href="#posterior"></a>
</h2>
<p>With independent prior distributions, the joint posterior
distribution for <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\boldsymbol{\beta}\)</span> in the Poisson model
is proportional to the product of the priors and the <span class="math inline">\(N\)</span> likelihood contributions:</p>
<p><span class="math display">\[f\left(\alpha,\boldsymbol{\beta} |
\mathbf{y},\mathbf{X}\right) \propto
  f\left(\alpha\right) \times \prod_{k=1}^K f\left(\beta_k\right) \times
  \prod_{i=1}^N {
  \frac{g^{-1}(\eta_i)^{y_i}}{y_i!} e^{-g^{-1}(\eta_i)}}.\]</span></p>
<p>This is posterior distribution that <code>stan_glm</code> will draw
from when using MCMC.</p>
</div>
<div class="section level2">
<h2 id="poisson-and-negative-binomial-regression-example">Poisson and Negative Binomial Regression Example<a class="anchor" aria-label="anchor" href="#poisson-and-negative-binomial-regression-example"></a>
</h2>
<p>This example comes from Chapter 8.3 of <a href="https://sites.stat.columbia.edu/gelman/arm/" class="external-link">Gelman and Hill
(2007)</a>.</p>
<p>We want to make inferences about the efficacy of a certain pest
management system at reducing the number of roaches in urban apartments.
Here is how Gelman and Hill describe the experiment (pg. 161):</p>
<blockquote>
<p>[…] the treatment and control were applied to 160 and 104 apartments,
respectively, and the outcome measurement <span class="math inline">\(y_i\)</span> in each apartment <span class="math inline">\(i\)</span> was the number of roaches caught in a
set of traps. Different apartments had traps for different numbers of
days […]</p>
</blockquote>
<p>In addition to an intercept, the regression predictors for the model
are the pre-treatment number of roaches <code>roach1</code>, the
treatment indicator <code>treatment</code>, and a variable indicating
whether the apartment is in a building restricted to elderly residents
<code>senior</code>. Because the number of days for which the roach
traps were used is not the same for all apartments in the sample, we
include it as an exposure, which slightly changes the model described in
the <strong>Likelihood</strong> section above in that the rate parameter
<span class="math inline">\(\lambda_i =
exp(\eta_i)\)</span> is multiplied by the exposure <span class="math inline">\(u_i\)</span> giving us <span class="math inline">\(y_i \sim Poisson(u_i \lambda_i)\)</span>. This is
equivalent to adding <span class="math inline">\(\ln{(u_i)}\)</span> to
the linear predictor <span class="math inline">\(\eta_i\)</span> and it
can be specified using the <code>offset</code> argument to
<code>stan_glm</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/rstanarm/">rstanarm</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">roaches</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Rescale</span></span>
<span><span class="va">roaches</span><span class="op">$</span><span class="va">roach1</span> <span class="op">&lt;-</span> <span class="va">roaches</span><span class="op">$</span><span class="va">roach1</span> <span class="op">/</span> <span class="fl">100</span></span>
<span><span class="co"># Estimate original model</span></span>
<span><span class="va">glm1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">roach1</span> <span class="op">+</span> <span class="va">treatment</span> <span class="op">+</span> <span class="va">senior</span>, offset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">exposure2</span><span class="op">)</span>, </span>
<span>            data <span class="op">=</span> <span class="va">roaches</span>, family <span class="op">=</span> <span class="va">poisson</span><span class="op">)</span></span>
<span><span class="co"># Estimate Bayesian version with stan_glm</span></span>
<span><span class="va">stan_glm1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stan_glm.html">stan_glm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">roach1</span> <span class="op">+</span> <span class="va">treatment</span> <span class="op">+</span> <span class="va">senior</span>, offset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">exposure2</span><span class="op">)</span>,</span>
<span>                      data <span class="op">=</span> <span class="va">roaches</span>, family <span class="op">=</span> <span class="va">poisson</span>, </span>
<span>                      prior <span class="op">=</span> <span class="fu"><a href="../reference/priors.html">normal</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2.5</span><span class="op">)</span>, </span>
<span>                      prior_intercept <span class="op">=</span> <span class="fu"><a href="../reference/priors.html">normal</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">5</span><span class="op">)</span>,</span>
<span>                      seed <span class="op">=</span> <span class="fl">12345</span><span class="op">)</span></span></code></pre></div>
<p>The <code>formula</code>, <code>data</code>, <code>family</code>, and
<code>offset</code> arguments to <code>stan_glm</code> can be specified
in exactly the same way as for <code>glm</code>. The
<code>poisson</code> family function defaults to using the log link, but
to write code readable to someone not familiar with the defaults we
should be explicit and use
<code>family = poisson(link = "log")</code>.</p>
<p>We’ve also specified some optional arguments. The <code>chains</code>
argument controls how many Markov chains are executed, the
<code>cores</code> argument controls the number of cores utilized by the
computer when fitting the model. We also provided a seed so that we have
the option to deterministically reproduce these results at any time. The
<code>stan_glm</code> function has many other optional arguments that
allow for more user control over the way estimation is performed. The
documentation for <code>stan_glm</code> has more information about these
controls as well as other topics related to GLM estimation.</p>
<p>Here are the point estimates and uncertainties from the
<code>glm</code> fit and <code>stan_glm</code> fit, which we see are
nearly identical:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span>glm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">glm1</span><span class="op">)</span>, stan_glm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">stan_glm1</span><span class="op">)</span><span class="op">)</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<pre><code>         (Intercept) roach1 treatment senior
glm             3.09    0.7     -0.52  -0.38
stan_glm        3.09    0.7     -0.52  -0.38</code></pre>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span>glm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">glm1</span><span class="op">)</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span>, <span class="st">"Std. Error"</span><span class="op">]</span>, </span>
<span>            stan_glm <span class="op">=</span> <span class="fu"><a href="../reference/se.html">se</a></span><span class="op">(</span><span class="va">stan_glm1</span><span class="op">)</span><span class="op">)</span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<pre><code>         (Intercept) roach1 treatment senior
glm            0.021  0.009     0.025  0.033
stan_glm       0.021  0.009     0.024  0.034</code></pre>
<p>(Note: the dataset we have is slightly different from the one used in
Gelman and Hill (2007), which leads to slightly different parameter
estimates than those shown in the book even when copying the
<code>glm</code> call verbatim. Also, we have rescaled the
<code>roach1</code> predictor. For the purposes of this example, the
actual estimates are less important than the process.)</p>
<p>Gelman and Hill next show how to compare the observed data to
replicated datasets from the model to check the quality of the fit. Here
we don’t show the original code used by Gelman and Hill because it’s
many lines, requiring several loops and some care to get the matrix
multiplications right (see pg. 161-162). On the other hand, the
<strong>rstanarm</strong> package makes this easy. We can generate
replicated datasets with a single line of code using the
<code>posterior_predict</code> function:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">yrep</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/posterior_predict.stanreg.html">posterior_predict</a></span><span class="op">(</span><span class="va">stan_glm1</span><span class="op">)</span></span></code></pre></div>
<p>By default <code>posterior_predict</code> will generate a dataset for
each set of parameter draws from the posterior distribution. That is,
<code>yrep</code> will be an <span class="math inline">\(S \times
N\)</span> matrix, where <span class="math inline">\(S\)</span> is the
size of the posterior sample and <span class="math inline">\(N\)</span>
is the number of data points. Each row of <code>yrep</code> represents a
full dataset generated from the posterior predictive distribution. For
more about the importance of the <code>posterior_predict</code>
function, see the <a href="rstanarm.html">“How to Use the
<strong>rstanarm</strong> Package”</a> vignette.</p>
<p>Gelman and Hill take the simulated datasets and for each of them
compute the proportion of zeros and compare to the observed proportion
in the original data. We can do this easily using the
<code>pp_check</code> function, which generates graphical comparisons of
the data <code>y</code> and replicated datasets <code>yrep</code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prop_zero</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">y</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">prop_zero_test1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pp_check.stanreg.html">pp_check</a></span><span class="op">(</span><span class="va">stan_glm1</span>, plotfun <span class="op">=</span> <span class="st">"stat"</span>, stat <span class="op">=</span> <span class="st">"prop_zero"</span>, binwidth <span class="op">=</span> <span class="fl">.005</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="count_files/figure-html/count-roaches-plot-pp_check1-1.png" class="r-plt" width="60%" style="display: block; margin: auto;"></p>
<p>The value of the test statistic (in this case the proportion of
zeros) computed from the sample <code>y</code> is the dark blue vertical
line. More than 30% of these observations are zeros, whereas the
replicated datasets all contain less than 1% zeros (light blue
histogram). This is a sign that we should consider a model that more
accurately accounts for the large proportion of zeros in the data.
Gelman and Hill show how we can do this using an overdispersed Poisson
regression. To illustrate the use of a different <code>stan_glm</code>
model, here we will instead try <a href="https://en.wikipedia.org/wiki/Negative_binomial_distribution" class="external-link">negative
binomial</a> regression, which is also used for overdispersed or
zero-inflated count data. The negative binomial distribution allows the
(conditional) mean and variance of <span class="math inline">\(y\)</span> to differ unlike the Poisson
distribution. To fit the negative binomial model can either use the
<code>stan_glm.nb</code> function or, equivalently, change the
<code>family</code> we specify in the call to <code>stan_glm</code> to
<code>neg_binomial_2</code> instead of <code>poisson</code>. To do the
latter we can just use <code>update</code>:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stan_glm2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">stan_glm1</span>, family <span class="op">=</span> <span class="va">neg_binomial_2</span><span class="op">)</span> </span></code></pre></div>
<p>We now use <code>pp_check</code> again, this time to check the
proportion of zeros in the replicated datasets under the negative
binomial model:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prop_zero_test2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pp_check.stanreg.html">pp_check</a></span><span class="op">(</span><span class="va">stan_glm2</span>, plotfun <span class="op">=</span> <span class="st">"stat"</span>, stat <span class="op">=</span> <span class="st">"prop_zero"</span>, </span>
<span>                            binwidth <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="co"># Show graphs for Poisson and negative binomial side by side</span></span>
<span><span class="fu"><a href="https://mc-stan.org/bayesplot/reference/bayesplot_grid.html" class="external-link">bayesplot_grid</a></span><span class="op">(</span><span class="va">prop_zero_test1</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Poisson"</span><span class="op">)</span>, </span>
<span>               <span class="va">prop_zero_test2</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Negative Binomial"</span><span class="op">)</span>, </span>
<span>               grid_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="count_files/figure-html/count-roaches-plot-pp_check2-1.png" class="r-plt" width="80%" style="display: block; margin: auto;"></p>
<p>This is a much better fit, as the proportion of zeros in the data
falls nicely near the center of the distribution of the proportion of
zeros among the replicated datasets. The observed proportion of zeros is
quite plausible under this model.</p>
<p>We could have also made these plots manually without using the
<code>pp_check</code> function because we have the <code>yrep</code>
datasets created by <code>posterior_predict</code>. The
<code>pp_check</code> function takes care of this for us, but
<code>yrep</code> can be used directly to carry out other posterior
predictive checks that aren’t automated by <code>pp_check</code>.</p>
<p>When we comparing the models using the <strong>loo</strong> package
we also see a clear preference for the negative binomial model</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">loo1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loo.stanreg.html">loo</a></span><span class="op">(</span><span class="va">stan_glm1</span>, cores <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">loo2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loo.stanreg.html">loo</a></span><span class="op">(</span><span class="va">stan_glm2</span>, cores <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/loo.stanreg.html">loo_compare</a></span><span class="op">(</span><span class="va">loo1</span>, <span class="va">loo2</span><span class="op">)</span></span></code></pre></div>
<pre><code>          elpd_diff se_diff
stan_glm2     0.0       0.0
stan_glm1 -5345.4     706.7</code></pre>
<p>which is not surprising given the better fit we’ve already observed
from the posterior predictive checks.</p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>Gelman, A. and Hill, J. (2007). <em>Data Analysis Using Regression
and Multilevel/Hierarchical Models.</em> Cambridge University Press,
Cambridge, UK.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Jonah Gabry, Ben Goodrich.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
