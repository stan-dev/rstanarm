<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!-- upstream: inst/BS5/templates/head.html; pkgdown-version: 2.1.3, fe04924 --><!-- https://github.com/r-lib/pkgdown/tree/fe04924b3df129bea60ac871614b01d87bcae147 --><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>How to Use the rstanarm Package • rstanarm</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_3-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- Font Awesome 7.0.1 for Bluesky icon --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" referrerpolicy="no-referrer">
<!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="How to Use the rstanarm Package">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <!-- upstream: inst/BS5/templates/navbar.html; pkgdown-version: 2.1.3, fe04924 -->
<!-- https://github.com/r-lib/pkgdown/tree/fe04924b3df129bea60ac871614b01d87bcae147 -->
<nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">


    <a class="navbar-brand me-2" href="../index.html">
      <!-- Add Stan logo -->
      <picture><source type="image/svg+xml" srcset="../logo.svg"><img src="../logo.png" class="stan-logo" alt="Stan blue hex logo"></source></picture>
      rstanarm
    </a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.32.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html" aria-label="Go to homepage"><span class="fa fa-home fa-lg"></span></a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Vignettes</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Functions</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-other-packages" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Other Packages</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-other-packages">
<li><a class="external-link dropdown-item" href="https://mc-stan.org/bayesplot">bayesplot</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/cmdstanr">cmdstanr</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/loo">loo</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/posterior">posterior</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/projpred">projpred</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/rstan">rstan</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/rstantools">rstantools</a></li>
    <li><a class="external-link dropdown-item" href="https://mc-stan.org/shinystan">shinystan</a></li>
  </ul>
</li>
<li class="nav-item"><a class="external-link nav-link" href="https://mc-stan.org/about/">About Stan</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://bsky.app/profile/did:plc:qznndgdnkem2yryu7ipqbpv7" aria-label="Visit our Bluesky profile"><span class="fa fa-brands fa-bluesky"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://discourse.mc-stan.org/" aria-label="Visit our forums"><span class="fa fa-users"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/stan-dev/rstanarm/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>How to Use the rstanarm Package</h1>
                        <h4 data-toc-skip class="author">Jonah Gabry and
Ben Goodrich</h4>
            
            <h4 data-toc-skip class="date">2025-12-01</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/stan-dev/rstanarm/blob/New-pkgdown-theme/vignettes/rstanarm.Rmd" class="external-link"><code>vignettes/rstanarm.Rmd</code></a></small>
      <div class="d-none name"><code>rstanarm.Rmd</code></div>
    </div>

    
    
<!--
%\VignetteEngine{knitr::rmarkdown}
%\VignetteIndexEntry{How to Use the rstanarm Package}
-->
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/bayesplot/" class="external-link">bayesplot</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/get_theme.html" class="external-link">theme_set</a></span><span class="op">(</span><span class="fu">bayesplot</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/bayesplot/reference/theme_default.html" class="external-link">theme_default</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette provides an <em>overview</em> of how to use the
functions in the <strong>rstanarm</strong> package that focuses on
commonalities. The other <strong>rstanarm</strong> vignettes go into the
particularities of each of the individual model-estimating
functions.</p>
<p>The goal of the <strong>rstanarm</strong> package is to make Bayesian
estimation <em>routine</em> for the most common regression models that
applied researchers use. This will enable researchers to avoid the
counter-intuitiveness of the frequentist approach to probability and
statistics with only minimal changes to their existing R scripts.</p>
<p>The four steps of a Bayesian analysis are</p>
<ol style="list-style-type: decimal">
<li>Specify a joint distribution for the outcome(s) and all the
unknowns, which typically takes the form of a marginal prior
distribution for the unknowns multiplied by a likelihood for the
outcome(s) conditional on the unknowns. This joint distribution is
proportional to a posterior distribution of the unknowns conditional on
the observed data</li>
<li>Draw from posterior distribution using Markov Chain Monte Carlo
(MCMC).</li>
<li>Evaluate how well the model fits the data and possibly revise the
model.</li>
<li>Draw from the posterior predictive distribution of the outcome(s)
given interesting values of the predictors in order to visualize how a
manipulation of a predictor affects (a function of) the outcome(s).</li>
</ol>
<p>Step 1 is necessarily model-specific and is covered in more detail in
the other vignettes that cover specific forms of the marginal prior
distribution and likelihood of the outcome. It is somewhat more involved
than the corresponding first step of a frequentist analysis, which only
requires that the likelihood of the outcome be specified. However, the
default priors in the <strong>rstanarm</strong> package should work well
in the majority of cases. Steps 2, 3, and 4 are the focus of this
vignette because they are largely not specific to how the joint
distribution in Step 1 is specified.</p>
<p>The key concept in Step 3 and Step 4 is the posterior predictive
distribution, which is the distribution of the outcome implied by the
model after having used the observed data to update our beliefs about
the unknown parameters. Frequentists, by definition, have no posterior
predictive distribution and frequentist predictions are subtly different
from what applied researchers seek. Maximum likelihood estimates do
<em>not</em> condition on the observed outcome data and so the
uncertainty in the estimates pertains to the variation in the sampling
distribution of the estimator, i.e. the distribution of estimates that
would occur if we could repeat the process of drawing a random sample
from a well-defined population and apply the estimator to each sample.
It is possible to construct a distribution of predictions under the
frequentist paradigm but it evokes the hypothetical of repeating the
process of drawing a random sample, applying the estimator each time,
and generating point predictions of the outcome. In contrast, the
posterior predictive distribution conditions on the observed outcome
data in hand to update beliefs about the unknowns and the variation in
the resulting distribution of predictions reflects the remaining
uncertainty in our beliefs about the unknowns.</p>
</div>
<div class="section level2">
<h2 id="step-1-specify-a-posterior-distribution">Step 1: Specify a posterior distribution<a class="anchor" aria-label="anchor" href="#step-1-specify-a-posterior-distribution"></a>
</h2>
<p>For the sake of discussion, we need some posterior distribution to
draw from. We will utilize an example from the <strong>HSAUR3</strong>
package by Brian S. Everitt and Torsten Hothorn, which is used in their
2014 book <em>A Handbook of Statistical Analyses Using R (3rd
Edition)</em> (Chapman &amp; Hall / CRC). This book is frequentist in
nature and we will show how to obtain the corresponding Bayesian
results.</p>
<p>The model in section 6.3.2 pertains to whether a survey respondent
agrees or disagrees with a conservative statement about the role of
women in society, which is modeled as a function of the gender and
education of the respondents. The posterior distribution — with
independent priors — can be written as <span class="math display">\[f\left(\alpha,\beta_1,\beta_2|\mathbf{y},\mathbf{X}\right)
\propto
  f\left(\alpha\right) f\left(\beta_1\right) f\left(\beta_2\right)
\times
  \prod_{i=1}^J {
  g^{-1}\left(\eta_i\right)^{y_i}
  \left(1 - g^{-1}\left(\eta_i\right)\right)^{n_i-y_i}},\]</span> where
<span class="math inline">\(\eta_i = \alpha + \beta_1 \mbox{education}_i
+ \beta_2 \mbox{Female}_i\)</span> is the linear predictor and a
function of an intercept <span class="math inline">\(\left(\alpha\right)\)</span>, a coefficient on the
years of education <span class="math inline">\(\left(\beta_1\right)\)</span>, and an
intercept-shift <span class="math inline">\(\left(\beta_2\right)\)</span> for the case where
the respondent is female. These data are organized such that <span class="math inline">\(y_i\)</span> is the number of respondents who
agree with the statement that have the same level of education and the
same gender, and <span class="math inline">\(n_i - y_i\)</span> is the
number of such people who disagree with the statement. The inverse link
function, <span class="math inline">\(p = g^{-1}\left(\eta_i
\right)\)</span>, for a binomial likelihood can be one of several
Cumulative Distribution Functions (CDFs) but in this case is the
standard logistic CDF, <span class="math inline">\(g^{-1}\left(\eta_i
\right)=\frac{1}{1 + e^{-\eta_i}}\)</span>.</p>
<p>Suppose we believe — prior to seeing the data — that <span class="math inline">\(\alpha\)</span>, <span class="math inline">\(\beta_1\)</span>, and <span class="math inline">\(\beta_2\)</span> are probably close to zero, are
as likely to be positive as they are to be negative, but have a small
chance of being quite far from zero. These beliefs can be represented by
Student t distributions with a few degrees of freedom in order to
produce moderately heavy tails. In particular, we will specify seven
degrees of freedom. Note that these purported beliefs may well be more
skeptical than your actual beliefs, which are probably that women and
people with more education have less conservative societal views.</p>
<div class="section level4">
<h4 id="note-on-prior-beliefs-and-default-priors">Note on “prior beliefs” and default priors<a class="anchor" aria-label="anchor" href="#note-on-prior-beliefs-and-default-priors"></a>
</h4>
<p>In this vignette we use the term “prior beliefs” to refer in
generality to the information content of the prior distribution
(conditional on the model). Sometimes previous research on the topic of
interest motivates beliefs about model parameters, but other times such
work may not exist or several studies may make contradictory claims.
Regardless, we nearly always have <em>some</em> knowledge that should be
reflected in our choice of prior distributions. For example, no one
believes a logistic regression coefficient will be greater than five in
absolute value if the predictors are scaled reasonably. You may also
have seen examples of so-called “non-informative” (or “vague”,
“diffuse”, etc.) priors like a normal distribution with a variance of
1000. When data are reasonably scaled, these priors are almost always a
bad idea for various reasons (they give non-trivial weight to extreme
values, reduce computational efficiency, etc). The default priors in
<strong>rstanarm</strong> are designed to be <em>weakly
informative</em>, by which we mean that they avoid placing unwarranted
prior weight on nonsensical parameter values and provide some
regularization to avoid overfitting, but also do allow for extreme
values if warranted by the data. If additional information is available,
the weakly informative defaults can be replaced with more informative
priors.</p>
</div>
</div>
<div class="section level2">
<h2 id="step-2-draw-from-the-posterior-distribution">Step 2: Draw from the posterior distribution<a class="anchor" aria-label="anchor" href="#step-2-draw-from-the-posterior-distribution"></a>
</h2>
<p>The likelihood for the sample is just the product over the <span class="math inline">\(J\)</span> groups of <span class="math display">\[g^{-1}\left(\eta_i \right)^{y_i}
  \left(1 - g^{-1}\left(\eta_i \right)\right)^{n_i-y_i},\]</span> which
can be maximized over <span class="math inline">\(\alpha\)</span>, <span class="math inline">\(\beta_1\)</span>, and <span class="math inline">\(\beta_2\)</span> to obtain frequentist estimates
by calling</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"womensrole"</span>, package <span class="op">=</span> <span class="st">"HSAUR3"</span><span class="op">)</span></span>
<span><span class="va">womensrole</span><span class="op">$</span><span class="va">total</span> <span class="op">&lt;-</span> <span class="va">womensrole</span><span class="op">$</span><span class="va">agree</span> <span class="op">+</span> <span class="va">womensrole</span><span class="op">$</span><span class="va">disagree</span></span>
<span><span class="va">womensrole_glm_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">agree</span>, <span class="va">disagree</span><span class="op">)</span> <span class="op">~</span> <span class="va">education</span> <span class="op">+</span> <span class="va">gender</span>,</span>
<span>                        data <span class="op">=</span> <span class="va">womensrole</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"logit"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">womensrole_glm_1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<pre><code>             Estimate Std. Error z value Pr(&gt;|z|)
(Intercept)     2.509      0.184  13.646    0.000
education      -0.271      0.015 -17.560    0.000
genderFemale   -0.011      0.084  -0.136    0.892</code></pre>
<p>The p-value for the null hypothesis that <span class="math inline">\(\beta_1 = 0\)</span> is very small, while the
p-value for the null hypothesis that <span class="math inline">\(\beta_2
= 0\)</span> is very large. However, frequentist p-values are awkward
because they do not pertain to the probability that a scientific
hypothesis is true but rather to the probability of observing a <span class="math inline">\(z\)</span>-statistic that is so large (in
magnitude) if the null hypothesis were true. The desire to make
probabilistic statements about a scientific hypothesis is one reason why
many people are drawn to the Bayesian approach.</p>
<p>A model with the same likelihood but Student t priors with seven
degrees of freedom can be specified using the <strong>rstanarm</strong>
package in a similar way by prepending <code>stan_</code> to the
<code>glm</code> call and specifying priors (and optionally the number
of cores on your computer to utilize):</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/rstanarm/">rstanarm</a></span><span class="op">)</span></span>
<span><span class="va">womensrole_bglm_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stan_glm.html">stan_glm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">agree</span>, <span class="va">disagree</span><span class="op">)</span> <span class="op">~</span> <span class="va">education</span> <span class="op">+</span> <span class="va">gender</span>,</span>
<span>                              data <span class="op">=</span> <span class="va">womensrole</span>,</span>
<span>                              family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"logit"</span><span class="op">)</span>, </span>
<span>                              prior <span class="op">=</span> <span class="fu"><a href="../reference/priors.html">student_t</a></span><span class="op">(</span>df <span class="op">=</span> <span class="fl">7</span>, <span class="fl">0</span>, <span class="fl">5</span><span class="op">)</span>, </span>
<span>                              prior_intercept <span class="op">=</span> <span class="fu"><a href="../reference/priors.html">student_t</a></span><span class="op">(</span>df <span class="op">=</span> <span class="fl">7</span>, <span class="fl">0</span>, <span class="fl">5</span><span class="op">)</span>,</span>
<span>                              cores <span class="op">=</span> <span class="fl">2</span>, seed <span class="op">=</span> <span class="fl">12345</span><span class="op">)</span></span>
<span><span class="va">womensrole_bglm_1</span></span></code></pre></div>
<pre><code>stan_glm
 family:       binomial [logit]
 formula:      cbind(agree, disagree) ~ education + gender
 observations: 42
 predictors:   3
------
             Median MAD_SD
(Intercept)   2.5    0.2  
education    -0.3    0.0  
genderFemale  0.0    0.1  

------
* For help interpreting the printed output see ?print.stanreg
* For info on the priors used see ?prior_summary.stanreg</code></pre>
<p>As can be seen, the “Bayesian point estimates” — which are
represented by the posterior medians — are very similar to the maximum
likelihood estimates. Frequentists would ask whether the point estimate
is greater in magnitude than double the estimated standard deviation of
the sampling distribution. But here we simply have estimates of the
standard deviation of the marginal posterior distributions, which are
based on a scaling of the Median Absolute Deviation (MAD) from the
posterior medians to obtain a robust estimator of the posterior standard
deviation. In addition, we can use the <code>posterior_interval</code>
function to obtain a Bayesian uncertainty interval for <span class="math inline">\(\beta_1\)</span>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ci95</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/posterior_interval.stanreg.html">posterior_interval</a></span><span class="op">(</span><span class="va">womensrole_bglm_1</span>, prob <span class="op">=</span> <span class="fl">0.95</span>, pars <span class="op">=</span> <span class="st">"education"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">ci95</span>, <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span>          <span class="fl">2.5</span><span class="op">% 97.5%</span></span>
<span><span class="va">education</span> <span class="op">-</span><span class="fl">0.3</span> <span class="op">-</span><span class="fl">0.24</span></span></code></pre>
<p>Unlike frequentist confidence intervals — which are <em>not</em>
interpretable in terms of post-data probabilities — the Bayesian
uncertainty interval indicates we believe after seeing the data that
there is a <span class="math inline">\(0.95\)</span> probability that
<span class="math inline">\(\beta_2\)</span> is between
<code>ci95[1,1]</code> and <code>ci95[1,2]</code>. Alternatively, we
could say that there is essentially zero probability that <span class="math inline">\(\beta_2 &gt; 0\)</span>, although frequentists
cannot make such a claim coherently.</p>
<p>Many of the post-estimation methods that are available for a model
that is estimated by <code>glm</code> are also available for a model
that is estimated by <code>stan_glm</code>. For example,</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>Median <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">womensrole_bglm_1</span><span class="op">)</span>, MAD_SD <span class="op">=</span> <span class="fu"><a href="../reference/se.html">se</a></span><span class="op">(</span><span class="va">womensrole_bglm_1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>                  Median     MAD_SD
(Intercept)   2.52098276 0.18285768
education    -0.27153061 0.01556542
genderFemale -0.01262136 0.08463091</code></pre>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span><span class="va">womensrole_bglm_1</span><span class="op">)</span><span class="op">)</span> <span class="co"># not deviance residuals</span></span></code></pre></div>
<pre><code>      Min.    1st Qu.     Median       Mean    3rd Qu.       Max.       NA's 
-0.3076575 -0.0359870 -0.0041319 -0.0003265  0.0660755  0.2822688          1 </code></pre>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cov2cor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/vcov.html" class="external-link">vcov</a></span><span class="op">(</span><span class="va">womensrole_bglm_1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>             (Intercept)   education genderFemale
(Intercept)    1.0000000 -0.93963167  -0.23059559
education     -0.9396317  1.00000000  -0.02463045
genderFemale  -0.2305956 -0.02463045   1.00000000</code></pre>
<p><strong>rstanarm</strong> does provide a <code>confint</code> method,
although it is reserved for computing confidence intervals in the case
that the user elects to estimate a model by (penalized) maximum
likelihood. When using full Bayesian inference (the
<strong>rstanarm</strong> default) or approximate Bayesian inference the
<code>posterior_interval</code> function should be used to obtain
Bayesian uncertainty intervals.</p>
</div>
<div class="section level2">
<h2 id="step-3-criticize-the-model">Step 3: Criticize the model<a class="anchor" aria-label="anchor" href="#step-3-criticize-the-model"></a>
</h2>
<p>The <code>launch_shinystan</code> function in the
<strong>shinystan</strong> package provides almost all the tools you
need to visualize the posterior distribution and diagnose any problems
with the Markov chains. In this case, the results are fine and to verify
that, you can call</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/launch_shinystan.stanreg.html">launch_shinystan</a></span><span class="op">(</span><span class="va">womensrole_bglm_1</span>, ppd <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>which will open a web browser that drives the visualizations.</p>
<p>For the rest of this subsection, we focus on what users can do
programmatically to evaluate whether a model is adequate. A minimal
requirement for Bayesian estimates is that the model should fit the data
that the estimates conditioned on. The key function here is
<code>posterior_predict</code>, which can be passed a new
<code>data.frame</code> to predict out-of-sample, but in this case is
omitted to obtain in-sample posterior predictions:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y_rep</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/posterior_predict.stanreg.html">posterior_predict</a></span><span class="op">(</span><span class="va">womensrole_bglm_1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">y_rep</span><span class="op">)</span></span></code></pre></div>
<pre><code>[1] 4000   42</code></pre>
<p>The resulting matrix has rows equal to the number of posterior
simulations, which in this case is <span class="math inline">\(2000\)</span> and columns equal to the number of
observations in the original dataset, which is <span class="math inline">\(42\)</span> combinations of education and gender.
Each element of this matrix is a predicted number of respondents with
that value of education and gender who agreed with the survey question
and thus should be reasonably close to the observed proportion of
agreements in the data. We can create a plot to check this:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">3.7</span>,<span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.1</span>, las <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/boxplot.html" class="external-link">boxplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sweep.html" class="external-link">sweep</a></span><span class="op">(</span><span class="va">y_rep</span><span class="op">[</span>,<span class="va">womensrole</span><span class="op">$</span><span class="va">gender</span> <span class="op">==</span> <span class="st">"Male"</span><span class="op">]</span>, <span class="fl">2</span>, STATS <span class="op">=</span> </span>
<span>               <span class="va">womensrole</span><span class="op">$</span><span class="va">total</span><span class="op">[</span><span class="va">womensrole</span><span class="op">$</span><span class="va">gender</span> <span class="op">==</span> <span class="st">"Male"</span><span class="op">]</span>, FUN <span class="op">=</span> <span class="st">"/"</span><span class="op">)</span>, </span>
<span>        axes <span class="op">=</span> <span class="cn">FALSE</span>, main <span class="op">=</span> <span class="st">"Male"</span>, pch <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>        xlab <span class="op">=</span> <span class="st">"Years of Education"</span>, ylab <span class="op">=</span> <span class="st">"Proportion of Agrees"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">womensrole</span>, <span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">1</span>, at <span class="op">=</span> <span class="va">education</span><span class="op">[</span><span class="va">gender</span> <span class="op">==</span> <span class="st">"Male"</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span>, </span>
<span>                      labels <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">20</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">2</span>, las <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">womensrole</span><span class="op">[</span><span class="va">womensrole</span><span class="op">$</span><span class="va">gender</span> <span class="op">==</span> <span class="st">"Male"</span>,<span class="op">]</span>, </span>
<span>     <span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="va">education</span> <span class="op">+</span> <span class="fl">1</span>,  <span class="va">agree</span> <span class="op">/</span> <span class="op">(</span><span class="va">agree</span> <span class="op">+</span> <span class="va">disagree</span><span class="op">)</span>, </span>
<span>            pch <span class="op">=</span> <span class="fl">16</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/boxplot.html" class="external-link">boxplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sweep.html" class="external-link">sweep</a></span><span class="op">(</span><span class="va">y_rep</span><span class="op">[</span>,<span class="va">womensrole</span><span class="op">$</span><span class="va">gender</span> <span class="op">==</span> <span class="st">"Female"</span><span class="op">]</span>, <span class="fl">2</span>, STATS <span class="op">=</span> </span>
<span>          <span class="va">womensrole</span><span class="op">$</span><span class="va">total</span><span class="op">[</span><span class="va">womensrole</span><span class="op">$</span><span class="va">gender</span> <span class="op">==</span> <span class="st">"Female"</span><span class="op">]</span>, FUN <span class="op">=</span> <span class="st">"/"</span><span class="op">)</span>, </span>
<span>          axes <span class="op">=</span> <span class="cn">FALSE</span>, main <span class="op">=</span> <span class="st">"Female"</span>, pch <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>        xlab <span class="op">=</span> <span class="st">"Years of Education"</span>, ylab <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">womensrole</span>, <span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">1</span>, at <span class="op">=</span> <span class="va">education</span><span class="op">[</span><span class="va">gender</span> <span class="op">==</span> <span class="st">"Female"</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span>,</span>
<span>     labels <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">20</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">womensrole</span><span class="op">[</span><span class="va">womensrole</span><span class="op">$</span><span class="va">gender</span> <span class="op">==</span> <span class="st">"Female"</span>,<span class="op">]</span>, </span>
<span>     <span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="va">education</span> <span class="op">+</span> <span class="fl">1</span>,  <span class="va">agree</span> <span class="op">/</span> <span class="op">(</span><span class="va">agree</span> <span class="op">+</span> <span class="va">disagree</span><span class="op">)</span>, </span>
<span>            pch <span class="op">=</span> <span class="fl">16</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="rstanarm_files/figure-html/rstanarm-criticism-plot-1.png" class="r-plt" alt="Posterior predictive boxplots vs. observed datapoints" width="90%"><p class="caption">
Posterior predictive boxplots vs. observed datapoints
</p>
</div>
<p>Here the boxplots provide the median, interquartile range, and hinges
of the posterior predictive distribution for a given gender and level of
education, while the red points represent the corresponding observed
data. As can be seen, the model predicts the observed data fairly well
for six to sixteen years of education but predicts less well for very
low or very high levels of education where there are less data.</p>
<p>Consequently, we might consider a model where education has a
quadratic effect on agreement, which is easy to specify using R’s
formula-based syntax.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">womensrole_bglm_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">womensrole_bglm_1</span>, formula. <span class="op">=</span> <span class="va">.</span> <span class="op">~</span> <span class="va">.</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">education</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>stan_glm
 family:       binomial [logit]
 formula:      cbind(agree, disagree) ~ education + gender + I(education^2)
 observations: 42
 predictors:   4
------
               Median MAD_SD
(Intercept)     2.1    0.4  
education      -0.2    0.1  
genderFemale    0.0    0.1  
I(education^2)  0.0    0.0  

------
* For help interpreting the printed output see ?print.stanreg
* For info on the priors used see ?prior_summary.stanreg</code></pre>
<p>Frequentists would test the null hypothesis that the coefficient on
the squared level of education is zero. Bayesians might ask whether such
a model is expected to produce better out-of-sample predictions than a
model with only the level of education. The latter question can be
answered using leave-one-out cross-validation or the approximation
thereof provided by the <code>loo</code> function in the
<strong>loo</strong> package, for which a method is provided by the
<strong>rstanarm</strong> package.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">loo_bglm_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loo.stanreg.html">loo</a></span><span class="op">(</span><span class="va">womensrole_bglm_1</span><span class="op">)</span></span>
<span><span class="va">loo_bglm_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loo.stanreg.html">loo</a></span><span class="op">(</span><span class="va">womensrole_bglm_2</span><span class="op">)</span></span></code></pre></div>
<p>First, we verify that the posterior is not too sensitive to any
particular observation in the dataset.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">3.8</span>,<span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.1</span>, las <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">loo_bglm_1</span>, label_points <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">loo_bglm_2</span>, label_points <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="rstanarm_files/figure-html/rstanarm-loo-plot-1.png" class="r-plt" width="70%" style="display: block; margin: auto;"></p>
<p>There are only one or two moderate outliers (whose statistics are
greater than <span class="math inline">\(0.5\)</span>), which should not
have too much of an effect on the resulting model comparison:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/loo.stanreg.html">loo_compare</a></span><span class="op">(</span><span class="va">loo_bglm_1</span>, <span class="va">loo_bglm_2</span><span class="op">)</span></span></code></pre></div>
<pre><code>                  elpd_diff se_diff
womensrole_bglm_1  0.0       0.0   
womensrole_bglm_2 -0.7       1.7   </code></pre>
<p>In this case, there is little difference in the expected log
pointwise deviance between the two models, so we are essentially
indifferent between them after taking into account that the second model
estimates an additional parameter. The “LOO Information Criterion
(LOOIC)”</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">loo_bglm_1</span></span></code></pre></div>
<pre><code>
Computed from 4000 by 42 log-likelihood matrix.

         Estimate   SE
elpd_loo   -104.8  9.5
p_loo         4.2  1.7
looic       209.7 18.9
------
MCSE of elpd_loo is NA.
MCSE and ESS estimates assume independent draws (r_eff=1).

Pareto k diagnostic values:
                         Count Pct.    Min. ESS
(-Inf, 0.7]   (good)     41    97.6%   446     
   (0.7, 1]   (bad)       0     0.0%   &lt;NA&gt;    
   (1, Inf)   (very bad)  1     2.4%   &lt;NA&gt;    
See help('pareto-k-diagnostic') for details.</code></pre>
<p>has the same purpose as the Akaike Information Criterion (AIC) that
is used by frequentists. Both are intended to estimate the expected log
predicted density (ELPD) for a new dataset. However, the AIC ignores
priors and assumes that the posterior distribution is multivariate
normal, whereas the functions from the loo package used here do not
assume that the posterior distribution is multivariate normal and
integrate over uncertainty in the parameters. This only assumes that any
one observation can be omitted without having a major effect on the
posterior distribution, which can be judged using the plots above.</p>
</div>
<div class="section level2">
<h2 id="step-4-analyze-manipulations-of-predictors">Step 4: Analyze manipulations of predictors<a class="anchor" aria-label="anchor" href="#step-4-analyze-manipulations-of-predictors"></a>
</h2>
<p>Frequentists attempt to interpret the estimates of the model, which
is difficult except when the model is linear, has no inverse link
function, and contains no interaction terms. Bayesians can avoid this
difficulty simply by inspecting the posterior predictive distribution at
different levels of the predictors. For example,</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># note: in newdata we want agree and disagree to sum to the number of people we</span></span>
<span><span class="co"># want to predict for. the values of agree and disagree don't matter so long as</span></span>
<span><span class="co"># their sum is the desired number of trials. we need to explicitly imply the</span></span>
<span><span class="co"># number of trials like this because our original data are aggregate. if we had</span></span>
<span><span class="co"># bernoulli data then it would be a given we wanted to predict for single</span></span>
<span><span class="co"># individuals.</span></span>
<span><span class="va">newdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>agree <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>, disagree <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>,<span class="fl">100</span><span class="op">)</span>, education <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">12</span>,<span class="fl">16</span><span class="op">)</span>,</span>
<span>                      gender <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="st">"Female"</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Male"</span>, <span class="st">"Female"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">y_rep</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/posterior_predict.stanreg.html">posterior_predict</a></span><span class="op">(</span><span class="va">womensrole_bglm_2</span>, <span class="va">newdata</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">y_rep</span>, <span class="fl">1</span>, <span class="va">diff</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 -41.00  -24.00  -20.00  -19.69  -16.00   -1.00 </code></pre>
<p>As can be seen, out of <span class="math inline">\(100\)</span> women
who have a college degree versus <span class="math inline">\(100\)</span> women with only a high school degree,
we would expect about <span class="math inline">\(20\)</span> fewer
college-educated women to agree with the question. There is an even
chance that the difference is between <span class="math inline">\(24\)</span> and <span class="math inline">\(16\)</span>, a one-in-four chance that it is
greater, and one-in-four chance that it is less.</p>
</div>
<div class="section level2">
<h2 id="troubleshooting">Troubleshooting<a class="anchor" aria-label="anchor" href="#troubleshooting"></a>
</h2>
<p>This section provides suggestions for how to proceed when you
encounter warning messages generated by the modeling functions in the
<strong>rstanarm</strong> package. The example models below are used
just for the purposes of concisely demonstrating certain difficulties
and possible remedies (we won’t worry about the merit of the models
themselves). The references at the end provide more information on the
relevant issues.</p>
<div class="section level4">
<h4 id="markov-chains-did-not-converge">Markov chains did not converge<a class="anchor" aria-label="anchor" href="#markov-chains-did-not-converge"></a>
</h4>
<p><strong>Recommendation:</strong> run the chains for more iterations
(in certain cases, see qualification below). <br></p>
<p>By default, all <strong>rstanarm</strong> modeling functions will run
four randomly initialized Markov chains, each for 2000 iterations
(including a warmup period of 1000 iterations that is discarded). All
chains must converge to the target distribution for inferences to be
valid. For most models, the default settings are sufficient, but if you
see a warning message about Markov chains not converging, the first
thing to try is increasing the number of iterations. This can be done by
specifying the <code>iter</code> argument. However, if all parameters
have proper priors (no priors were set to <code>NULL</code>), and you
used the default values for iterations (2000) and chains (4), and Rhats
(explained below) are greater than 2, then increasing the number of
iterations alone is unlikely to solve to the problem.</p>
<p>One way to monitor whether a chain has converged to the equilibrium
distribution is to compare its behavior to other randomly initialized
chains. This is the motivation for the Gelman and Rubin potential scale
reduction statistic Rhat. The Rhat statistic measures the ratio of the
average variance of the draws within each chain to the variance of the
pooled draws across chains; if all chains are at equilibrium, these will
be the same and Rhat will be one. If the chains have not converged to a
common distribution, the Rhat statistic will tend to be greater than
one.</p>
<p>Gelman and Rubin’s recommendation is that the independent Markov
chains be initialized with diffuse starting values for the parameters
and sampled until all values for Rhat are below 1.1. When any Rhat
values are above 1.1 <strong>rstanarm</strong> will print a warning
message like this:</p>
<pre><code>Markov chains did not converge! Do not analyze results! </code></pre>
<p>To illustrate how to check the Rhat values after fitting a model
using <strong>rstanarm</strong> we’ll fit two models and run them for
different numbers of iterations.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bad_rhat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stan_glm.html">stan_glm</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">mtcars</span>, iter <span class="op">=</span> <span class="fl">20</span>, chains <span class="op">=</span> <span class="fl">2</span>, seed <span class="op">=</span> <span class="fl">12345</span><span class="op">)</span></span></code></pre></div>
<pre><code>Warning: There were 2 chains where the estimated Bayesian Fraction of Missing Information was low. See
https://mc-stan.org/misc/warnings.html#bfmi-low</code></pre>
<pre><code>Warning: Examine the pairs() plot to diagnose sampling problems</code></pre>
<pre><code>Warning: The largest R-hat is 2.83, indicating chains have not mixed.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#r-hat</code></pre>
<pre><code>Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#bulk-ess</code></pre>
<pre><code>Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#tail-ess</code></pre>
<pre><code>Warning: Markov chains did not converge! Do not analyze results!</code></pre>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">good_rhat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">bad_rhat</span>, iter <span class="op">=</span> <span class="fl">1000</span>, chains <span class="op">=</span> <span class="fl">2</span>, seed <span class="op">=</span> <span class="fl">12345</span><span class="op">)</span></span></code></pre></div>
<p>Here the first model leads to the warning message about convergence
but the second model does not. Indeed, we can see that many Rhat values
are much bigger than 1 for the first model:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rhat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">bad_rhat</span><span class="op">)</span><span class="op">[</span>, <span class="st">"Rhat"</span><span class="op">]</span></span>
<span><span class="va">rhat</span><span class="op">[</span><span class="va">rhat</span> <span class="op">&gt;</span> <span class="fl">1.1</span><span class="op">]</span></span></code></pre></div>
<pre><code>  (Intercept)           cyl          drat            wt          qsec 
     2.341370      3.218821      2.270997      1.334041      1.350006 
           vs          gear          carb      mean_PPD log-posterior 
     2.335472      1.542550      1.948308      1.715434      1.564986 </code></pre>
<p>Since we didn’t get a warning for the second model we shouldn’t find
any parameters with an Rhat far from 1:</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">good_rhat</span><span class="op">)</span><span class="op">[</span>, <span class="st">"Rhat"</span><span class="op">]</span> <span class="op">&gt;</span> <span class="fl">1.1</span><span class="op">)</span></span></code></pre></div>
<pre><code>[1] FALSE</code></pre>
<p>Details on the computation of Rhat and some of its limitations can be
found in <a href="https://mc-stan.org/docs/" class="external-link">Stan Modeling Language
User’s Guide and Reference Manual</a>.</p>
</div>
<div class="section level4">
<h4 id="divergent-transitions">Divergent transitions<a class="anchor" aria-label="anchor" href="#divergent-transitions"></a>
</h4>
<p><strong>Recommendation:</strong> increase the target acceptance rate
<code>adapt_delta</code>. <br></p>
<p>Hamiltonian Monte Carlo (HMC), the MCMC algorithm used by <a href="https://mc-stan.org" class="external-link">Stan</a>, works by simulating the evolution
of a Hamiltonian system. Stan uses a <a href="https://en.wikipedia.org/wiki/Symplectic_integrator" class="external-link">symplectic
integrator</a> to approximate the exact solution of the Hamiltonian
dynamics. When the step size parameter is too large relative to the
curvature of the log posterior this approximation can diverge and
threaten the validity of the sampler. <strong>rstanarm</strong> will
print a warning if there are any divergent transitions after the warmup
period, in which case the posterior sample may be biased. The
recommended method is to increase the <code>adapt_delta</code> parameter
– target average proposal acceptance probability in the adaptation –
which will in turn reduce the step size. Each of the modeling functions
accepts an <code>adapt_delta</code> argument, so to increase
<code>adapt_delta</code> you can simply change the value from the
default value to a value closer to <span class="math inline">\(1\)</span>. To reduce the frequency with which
users need to manually set <code>adapt_delta</code>, the default value
depends on the prior distribution used (see
<code><a href="../reference/adapt_delta.html">help("adapt_delta",  package = "rstanarm")</a></code> for
details).</p>
<p>The downside to increasing the target acceptance rate – and, as a
consequence, decreasing the step size – is that sampling will tend to be
slower. Intuitively, this is because a smaller step size means that more
steps are required to explore the posterior distribution. Since the
validity of the estimates is not guaranteed if there are any post-warmup
divergent transitions, the slower sampling is a minor cost.</p>
</div>
<div class="section level4">
<h4 id="maximum-treedepth-exceeded">Maximum treedepth exceeded<a class="anchor" aria-label="anchor" href="#maximum-treedepth-exceeded"></a>
</h4>
<p><strong>Recommendation:</strong> increase the maximum allowed
treedepth <code>max_treedepth</code> unless all other convergence
diagnostics are ok. <br></p>
<p>Configuring the No-U-Turn-Sampler (the variant of HMC used by Stan)
involves putting a cap on the depth of the trees that it evaluates
during each iteration. This is controlled through a maximum depth
parameter <code>max_treedepth</code>. When the maximum allowed tree
depth is reached it indicates that NUTS is terminating prematurely to
avoid excessively long execution time. If <strong>rstanarm</strong>
prints a warning about transitions exceeding the maximum treedepth you
should try increasing the <code>max_treedepth</code> parameter using the
optional <code>control</code> argument. For example, to increase
<code>max_treedepth</code> to 16 (the default used
<strong>rstanarm</strong> is 15) you can provide the argument
<code>control = list(max_treedepth = 16)</code> to any of the
<strong>rstanarm</strong> modeling functions. If you do not see a
warning about hitting the maximum treedepth (which is rare), then you do
not need to worry.</p>
<p>With the models <strong>rstanarm</strong> is capable of fitting, when
you get a warning about max treedepth you will typically also get
warnings about other diagnostics. However, if you see a max treedepth
warning but all other convergence diagnostics are fine, you can
typically ignore the warning. In that case the warning likely indicates
efficiency issues but not that the results are invalid to analyze.</p>
</div>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>In this vignette, we have gone through the four steps of a Bayesian
analysis. The first step — specifying the posterior distribution —
varies considerably from one analysis to the next because the likelihood
function employed differs depending on the nature of the outcome
variable and our prior beliefs about the parameters in the model varies
not only from situation to situation but from researcher to researcher.
However, given a posterior distribution and given that this posterior
distribution can be drawn from using the <strong>rstanarm</strong>
package, the remaining steps are conceptually similar across analyses.
The key is to draw from the posterior predictive distribution of the
outcome, which is the what the model predicts the outcome to be after
having updated our beliefs about the unknown parameters with the
observed data. Posterior predictive distributions can be used for model
checking and for making inferences about how manipulations of the
predictors would affect the outcome.</p>
<p>Of course, all of this assumes that you have obtained draws from the
posterior distribution faithfully. The functions in the
<strong>rstanarm</strong> package will throw warnings if there is
evidence that the draws are tainted, and we have discussed some steps to
remedy these problems. For the most part, the model-fitting functions in
the <strong>rstanarm</strong> package are unlikely to produce many such
warnings, but they may appear in more complicated models.</p>
<p>If the posterior distribution that you specify in the first step
cannot be sampled from using the <strong>rstanarm</strong> package, then
it is often possible to create a hand-written program in the the Stan
language so that the posterior distribution can be drawn from using the
<strong>rstan</strong> package. See the documentation for the
<strong>rstan</strong> package or <a href="https://mc-stan.org" class="external-link uri">https://mc-stan.org</a> for more details about this more
advanced usage of Stan. However, many relatively simple models can be
fit using the <strong>rstanarm</strong> package without writing any code
in the Stan language, which is illustrated for each estimating function
in the <strong>rstanarm</strong> package in the other <a href="index.html">vignettes</a>.</p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>Betancourt, M. J., &amp; Girolami, M. (2013). Hamiltonian Monte Carlo
for hierarchical models. <a href="https://arxiv.org/abs/1312.0906" class="external-link">arXiv
preprint</a>.</p>
<p>Stan Development Team. (2015). <em>Stan modeling language user’s
guide and reference manual, Version 2.9.0</em>. <a href="https://mc-stan.org/docs/" class="external-link uri">https://mc-stan.org/docs/</a>. See the ‘Hamiltonian Monte
Carlo Sampling’ chapter.</p>
<p>Gelman, A., &amp; Rubin, D. B. (1992). Inference from iterative
simulation using multiple sequences. <em>Statistical Science</em>, 7(4),
457 – 472.</p>
<p>Gelman, A., &amp; Shirley, K. (2011). Inference from simulations and
monitoring convergence. In S. Brooks, A. Gelman, G. Jones, &amp; X. Meng
(Eds.), <em>Handbook of Markov chain Monte Carlo</em>. Boca Raton:
Chapman &amp; Hall/CRC.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Jonah Gabry, Ben Goodrich.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
